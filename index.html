<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Irrigation Prototype - V2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .hidden { display: none !important; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Modal Backdrop */
        .modal-backdrop { background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); }

        /* Highlight text */
        .text-glow { text-shadow: 0 0 20px rgba(52, 211, 153, 0.4); }
        .text-glow-red { text-shadow: 0 0 20px rgba(248, 113, 113, 0.4); }
        .text-glow-amber { text-shadow: 0 0 20px rgba(251, 191, 36, 0.4); }
    </style>
</head>
<body class="text-slate-800 antialiased h-screen flex flex-col overflow-hidden">

    <!-- Navbar -->
    <nav id="navbar" class="bg-white border-b border-slate-200 px-4 md:px-6 py-3 flex justify-between items-center shrink-0 hidden z-10">
        <div class="flex items-center gap-2 cursor-pointer" onclick="Router.navigate('dashboard')">
            <svg class="w-7 h-7 md:w-8 md:h-8 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path></svg>
            <span class="font-bold text-base md:text-lg tracking-tight text-emerald-900">AgriAI<span class="text-[10px] md:text-xs font-normal text-slate-400 ml-1">v2</span></span>
        </div>
        <div class="flex items-center gap-3 md:gap-4">
            <span id="nav-user-name" class="text-xs md:text-sm font-medium text-slate-600 hidden sm:block"></span>
            <button id="btn-admin-panel" onclick="Router.navigate('admin')" class="hidden relative text-xs md:text-sm bg-indigo-50 text-indigo-600 px-2 py-1 md:px-3 md:py-1.5 rounded-md font-medium hover:bg-indigo-100 transition">
                Admin
                <span id="admin-badge" class="hidden absolute -top-2 -right-2 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full">0</span>
            </button>
            <button onclick="Auth.logout()" class="text-xs md:text-sm text-slate-500 hover:text-red-600 transition font-medium">ƒêƒÉng xu·∫•t</button>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="flex-1 overflow-y-auto relative">
        
        <!-- ================= VIEW: GATE ================= -->
        <section id="view-gate" class="absolute inset-0 bg-emerald-900 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl p-6 md:p-8 w-full max-w-md text-center transform transition-all">
                <div class="w-16 h-16 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mx-auto mb-6">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                </div>
                <h1 class="text-xl md:text-2xl font-bold text-slate-800 mb-2">C·ªïng Truy C·∫≠p K√≠n</h1>
                <p class="text-slate-500 text-sm mb-6">Vui l√≤ng nh·∫≠p m√£ b√≠ m·∫≠t (8 ch·ªØ s·ªë) ƒë·ªÉ truy c·∫≠p h·ªá th·ªëng prototype.</p>
                
                <input type="password" id="gate-code" maxlength="8" class="w-full text-center tracking-[0.5em] font-mono text-xl md:text-2xl p-3 md:p-4 border-2 border-slate-200 rounded-xl focus:border-emerald-500 focus:ring-0 outline-none transition-colors mb-4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                <p id="gate-error" class="text-red-600 font-bold bg-red-50 py-2 px-3 rounded text-sm mb-4 hidden border border-red-200">M√£ b√≠ m·∫≠t kh√¥ng ch√≠nh x√°c!</p>
                
                <button onclick="checkGate()" class="w-full bg-emerald-600 text-white font-semibold py-3 rounded-xl hover:bg-emerald-700 transition shadow-lg shadow-emerald-200 mb-4">M·ªü Kh√≥a</button>
                <button onclick="Router.navigate('howitworks')" class="w-full bg-slate-100 text-slate-600 font-medium py-3 rounded-xl hover:bg-slate-200 transition text-sm md:text-base">Xem c√°ch ho·∫°t ƒë·ªông (Public Demo) ‚Üí</button>
            </div>
        </section>

        <!-- ================= VIEW: AUTH ================= -->
        <section id="view-auth" class="absolute inset-0 flex items-center justify-center p-4 bg-slate-50 hidden">
            <div class="bg-white rounded-2xl shadow-xl border border-slate-100 p-6 md:p-8 w-full max-w-md">
                <div class="flex justify-center mb-6">
                    <div class="flex p-1 bg-slate-100 rounded-lg w-full">
                        <button id="tab-login" onclick="UI.switchAuthTab('login')" class="flex-1 py-2 text-sm font-medium rounded-md bg-white shadow-sm text-slate-800">ƒêƒÉng nh·∫≠p</button>
                        <button id="tab-register" onclick="UI.switchAuthTab('register')" class="flex-1 py-2 text-sm font-medium rounded-md text-slate-500 hover:text-slate-800">ƒêƒÉng k√Ω</button>
                    </div>
                </div>

                <form id="form-login" onsubmit="Auth.handleLogin(event)">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Email</label>
                        <input type="email" id="login-email" required class="w-full p-2.5 border border-slate-300 rounded-lg focus:border-emerald-500 outline-none text-sm">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-slate-700 mb-1">M·∫≠t kh·∫©u</label>
                        <input type="password" id="login-pass" required class="w-full p-2.5 border border-slate-300 rounded-lg focus:border-emerald-500 outline-none text-sm">
                    </div>
                    <button type="submit" class="w-full bg-slate-800 text-white font-medium py-2.5 rounded-lg hover:bg-slate-900 transition">ƒêƒÉng nh·∫≠p</button>
                </form>

                <form id="form-register" class="hidden" onsubmit="Auth.handleRegister(event)">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-slate-700 mb-1">T√™n hi·ªÉn th·ªã</label>
                        <input type="text" id="reg-name" required class="w-full p-2.5 border border-slate-300 rounded-lg focus:border-emerald-500 outline-none text-sm">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Email</label>
                        <input type="email" id="reg-email" required class="w-full p-2.5 border border-slate-300 rounded-lg focus:border-emerald-500 outline-none text-sm">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-slate-700 mb-1">M·∫≠t kh·∫©u (t·ªëi thi·ªÉu 8 k√Ω t·ª±)</label>
                        <input type="password" id="reg-pass" required minlength="8" class="w-full p-2.5 border border-slate-300 rounded-lg focus:border-emerald-500 outline-none text-sm">
                    </div>
                    <button type="submit" class="w-full bg-emerald-600 text-white font-medium py-2.5 rounded-lg hover:bg-emerald-700 transition">T·∫°o t√†i kho·∫£n</button>
                </form>
            </div>
        </section>

        <!-- ================= VIEW: DASHBOARD ================= -->
        <section id="view-dashboard" class="max-w-6xl mx-auto p-4 md:p-6 hidden">
            <div class="flex justify-between items-end mb-6 md:mb-8">
                <div>
                    <h2 class="text-xl md:text-2xl font-bold text-slate-800">V∆∞·ªùn c·ªßa b·∫°n</h2>
                    <p class="text-slate-500 mt-1 text-xs md:text-sm">Qu·∫£n l√Ω t·ªëi ƒëa 3 c√¢y tr·ªìng.</p>
                </div>
                <div class="group relative">
                    <button id="btn-add-plant" onclick="UI.openPlantModal()" class="bg-emerald-600 text-white px-3 py-2 md:px-4 md:py-2 rounded-lg text-sm md:text-base font-medium hover:bg-emerald-700 transition flex items-center gap-1 md:gap-2">
                        <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        Th√™m c√¢y
                    </button>
                    <div id="tooltip-plant-limit" class="hidden absolute bottom-full right-0 mb-2 w-48 bg-slate-800 text-white text-xs rounded py-1 px-2 text-center z-10 shadow-lg">
                        ƒê√£ ƒë·∫°t gi·ªõi h·∫°n 3 c√¢y.
                    </div>
                </div>
            </div>

            <div id="plant-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
                <!-- Cards injected via JS -->
            </div>
            
            <div id="empty-state" class="hidden text-center py-16 md:py-20 bg-white rounded-2xl border border-slate-200 border-dashed mx-4 md:mx-0">
                <svg class="w-12 h-12 md:w-16 md:h-16 text-slate-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path></svg>
                <h3 class="text-base md:text-lg font-medium text-slate-700">Ch∆∞a c√≥ c√¢y n√†o</h3>
                <p class="text-slate-500 text-xs md:text-sm mt-1">H√£y th√™m c√¢y ƒë·∫ßu ti√™n ƒë·ªÉ AI b·∫Øt ƒë·∫ßu t√≠nh to√°n.</p>
            </div>
        </section>

        <!-- ================= VIEW: PLANT DETAIL ================= -->
        <section id="view-plant" class="max-w-6xl mx-auto p-4 md:p-6 hidden">
            <!-- Header Strip -->
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <div>
                    <button onclick="Router.navigate('dashboard')" class="text-slate-400 hover:text-slate-600 text-xs md:text-sm font-medium mb-1 flex items-center gap-1">‚Üê Quay l·∫°i</button>
                    <h2 id="pd-name" class="text-2xl md:text-3xl font-bold text-slate-800">T√™n c√¢y</h2>
                    <div class="flex flex-wrap gap-2 mt-2">
                        <p id="pd-type-tag" class="text-emerald-700 bg-emerald-100 px-2 py-0.5 rounded font-medium text-[10px] md:text-xs">Lo·∫°i c√¢y</p>
                        <p id="pd-loc-tag" class="text-indigo-700 bg-indigo-100 px-2 py-0.5 rounded font-medium text-[10px] md:text-xs">V·ªã tr√≠</p>
                        <p id="pd-age-tag" class="text-slate-700 bg-slate-200 px-2 py-0.5 rounded font-medium text-[10px] md:text-xs">Tu·ªïi</p>
                    </div>
                </div>
                <!-- Control Buttons -->
                <div class="grid grid-cols-2 sm:flex sm:flex-row gap-2 w-full md:w-auto bg-white p-1 rounded-lg border border-slate-200 shadow-sm items-center">
                    <button onclick="UI.openPlantModal(state.currentPlantId)" class="px-2 py-2 md:px-3 md:py-1.5 text-xs md:text-sm font-medium text-slate-600 hover:bg-slate-50 rounded">S·ª≠a c·∫•u h√¨nh</button>
                    <button onclick="exportPlantData()" class="px-2 py-2 md:px-3 md:py-1.5 text-xs md:text-sm font-medium text-slate-600 hover:bg-slate-50 rounded">Xu·∫•t JSON</button>
                    <button onclick="manualWater()" class="px-2 py-2 md:px-3 md:py-1.5 text-xs md:text-sm font-medium text-blue-600 hover:bg-blue-50 rounded border border-blue-100 flex items-center justify-center gap-1">
                        <svg class="w-3 h-3 md:w-4 md:h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 2.5c-.244 0-.472.105-.632.289l-5.25 6A.833.833 0 004.167 10h1.226a4.167 4.167 0 109.214 0h1.226a.833.833 0 00.049-1.211l-5.25-6A.833.833 0 0010 2.5z" clip-rule="evenodd"></path></svg>
                        B∆°m Ngay
                    </button>
                    <button onclick="UI.openReportModal()" class="px-2 py-2 md:px-3 md:py-1.5 text-xs md:text-sm font-medium text-amber-600 hover:bg-amber-50 rounded border border-amber-100 flex items-center justify-center gap-1">
                        B√°o l·ªói
                    </button>
                </div>
            </div>

            <!-- Alerts Panel -->
            <div id="alerts-panel" class="mb-6 space-y-2 empty:hidden"></div>

            <!-- HERO SOIL MOISTURE SECTION -->
            <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl shadow-lg p-6 md:p-8 mb-6 text-white relative overflow-hidden flex flex-col lg:flex-row items-center justify-between gap-6">
                <div class="absolute -right-10 -bottom-10 opacity-10 pointer-events-none">
                    <svg class="w-48 h-48 md:w-64 md:h-64" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a2 2 0 00-2 2v11a3 3 0 106 0V4a2 2 0 00-2-2H4zm1 14a1 1 0 100-2 1 1 0 000 2zm5-1.757l4.9-4.9a2 2 0 000-2.828L13.485 5.1a2 2 0 00-2.828 0L10 5.757v8.486zM16 18H9.071l6-6H16a2 2 0 012 2v2a2 2 0 01-2 2z" clip-rule="evenodd"></path></svg>
                </div>
                
                <div class="flex-1 z-10 text-center lg:text-left w-full">
                    <h3 class="text-slate-300 font-medium tracking-wide uppercase text-xs md:text-sm mb-2">ƒê·ªô ·∫©m ƒë·∫•t hi·ªán t·∫°i</h3>
                    <div class="flex flex-col sm:flex-row items-center justify-center lg:justify-start gap-2 sm:gap-4">
                        <span id="hero-moisture-val" class="text-5xl sm:text-6xl md:text-8xl font-black text-glow tracking-tighter text-emerald-400">--%</span>
                        <span id="hero-status-badge" class="px-3 py-1 mt-2 sm:mt-0 rounded-full text-xs md:text-sm font-bold bg-emerald-500/20 text-emerald-300 border border-emerald-500/30">Tuy·ªát v·ªùi</span>
                    </div>
                    <p class="text-slate-400 mt-4 text-xs md:text-sm flex items-center justify-center lg:justify-start gap-1.5">
                        <svg class="w-3.5 h-3.5 md:w-4 md:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        C·∫≠p nh·∫≠t: <span id="hero-updated-at" class="text-slate-200">--</span>
                    </p>
                </div>

                <div class="w-full lg:w-1/3 bg-slate-800/60 backdrop-blur rounded-xl p-4 md:p-5 border border-slate-700/50 z-10">
                    <h4 class="font-bold text-slate-200 flex items-center gap-2 mb-2 md:mb-4 text-sm md:text-base">
                        <svg class="w-4 h-4 md:w-5 md:h-5 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        M√°y D·ª± ƒêo√°n (Predictor)
                    </h4>
                    <p class="text-[10px] md:text-xs text-slate-400 mb-3">D·ª± b√°o m·ª©c ·∫©m t∆∞∆°ng lai (Max 5 ng√†y).</p>
                    <input type="datetime-local" id="predict-datetime" class="w-full bg-slate-900 border border-slate-600 text-white p-2 rounded text-xs md:text-sm mb-3 outline-none focus:border-indigo-500">
                    <button onclick="Predictor.runUserPrediction()" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-medium py-2 rounded transition shadow-lg shadow-indigo-500/30">T√≠nh To√°n Nhanh</button>
                </div>
            </div>

            <!-- Main Content Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Left: Visual UI -->
                <div class="bg-white rounded-2xl border border-slate-200 p-6 flex flex-col items-center justify-center relative min-h-[350px] md:min-h-[400px]">
                    <div class="absolute top-4 left-4 right-4 flex justify-between pointer-events-none">
                         <!-- Placeholder for extra badges if needed -->
                         <div></div> 
                         <div class="flex flex-col gap-2 items-end">
                            <div class="bg-slate-50 px-2 py-1 md:px-3 md:py-1 rounded-full text-[10px] md:text-xs font-medium text-slate-600 border border-slate-200 shadow-sm">
                                <span class="text-orange-500">Nhi·ªát: <span id="visual-temp">--</span>¬∞C</span>
                            </div>
                            <div class="bg-slate-50 px-2 py-1 md:px-3 md:py-1 rounded-full text-[10px] md:text-xs font-medium text-slate-600 border border-slate-200 shadow-sm">
                                <span class="text-blue-500">·∫®m KK: <span id="visual-humidity">--</span>%</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Dynamic SVG Plant -->
                    <svg class="w-40 h-56 md:w-48 md:h-64 overflow-visible mb-6 mt-8" viewBox="0 0 100 150">
                        <path id="svg-loc" d="M 20 100 L 80 100 L 70 140 L 30 140 Z" fill="#475569" />
                        <ellipse id="svg-loc-top" cx="50" cy="100" rx="30" ry="10" fill="#334155" />
                        <g id="svg-plant-group"></g>
                    </svg>

                    <!-- Plant Health Bar -->
                    <div class="w-full mt-auto">
                        <div class="flex justify-between text-xs md:text-sm mb-1">
                            <span class="text-slate-500 font-medium flex items-center gap-1">S·ª©c kh·ªèe sinh h·ªçc</span>
                            <span id="pb-health-text" class="font-bold text-slate-700">--%</span>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-2.5 overflow-hidden">
                            <div id="pb-health-fill" class="bg-blue-500 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                        <p id="health-status-text" class="text-[10px] md:text-xs text-slate-500 mt-1.5 italic font-medium">--</p>
                    </div>
                </div>

                <!-- Right: Data Panels -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Control & Simulation Panel -->
                    <div class="bg-white rounded-2xl border border-slate-200 p-5 md:p-6 shadow-sm">
                        <div class="flex flex-col md:flex-row md:items-center justify-between mb-4 border-b border-slate-100 pb-4 gap-3">
                            <h3 class="font-bold text-slate-800 flex items-center gap-2 text-sm md:text-base">
                                M√¥ ph·ªèng & ƒêi·ªÅu khi·ªÉn
                            </h3>
                            <div class="flex flex-wrap gap-2 items-center">
                                <span id="pulsed-status" class="hidden text-[10px] md:text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded animate-pulse border border-blue-200">ƒêang b∆°m...</span>
                                <div class="bg-slate-100 px-2 py-1 md:px-3 md:py-1 rounded text-xs md:text-sm font-medium text-slate-700 flex items-center gap-1">
                                    <span id="lbl-mode" class="text-emerald-600">--</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Weather Controls -->
                        <div class="flex flex-col sm:flex-row gap-3 sm:gap-2 mb-5 bg-slate-50 p-3 rounded-lg border border-slate-200 items-start sm:items-center justify-between w-full">
                            <div>
                                <span class="text-[10px] md:text-xs font-bold text-slate-600 block mb-1">Th·ªùi ti·∫øt API: <span id="lbl-weather-desc" class="font-normal text-indigo-600 ml-1">--</span></span>
                            </div>
                            <div class="flex flex-wrap gap-2 w-full sm:w-auto">
                                <button onclick="WeatherManager.setSim('sun')" class="flex-1 sm:flex-none text-[10px] md:text-xs bg-orange-100 text-orange-700 px-2 py-1.5 rounded hover:bg-orange-200 font-medium border border-orange-200">√âp N·∫Øng</button>
                                <button onclick="WeatherManager.setSim('rain')" class="flex-1 sm:flex-none text-[10px] md:text-xs bg-cyan-100 text-cyan-700 px-2 py-1.5 rounded hover:bg-cyan-200 font-medium border border-cyan-200">√âp M∆∞a</button>
                                <button onclick="WeatherManager.fetchForecast()" class="flex-1 sm:flex-none w-full sm:w-auto text-[10px] md:text-xs bg-indigo-100 text-indigo-700 px-2 py-1.5 rounded hover:bg-indigo-200 font-medium border border-indigo-200">D√πng API</button>
                            </div>
                        </div>

                        <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center">
                            <div class="bg-slate-50 px-3 py-2 md:px-4 md:py-2 rounded-lg border border-slate-200 w-full sm:w-auto">
                                <p class="text-[10px] md:text-xs text-slate-500 uppercase tracking-wider mb-1">Th·ªùi gian gi·∫£ l·∫≠p</p>
                                <p id="sim-time" class="font-mono font-medium text-slate-800 text-xs md:text-sm">--:--:--</p>
                            </div>
                            <div class="flex-1 w-full">
                                <label class="text-[10px] md:text-xs text-slate-500 block mb-1">T·ªëc ƒë·ªô (Auto-Stop sau 5 ng√†y)</label>
                                <select id="sim-speed" onchange="Simulation.setSpeed(parseInt(this.value))" class="text-xs md:text-sm p-1.5 border border-slate-300 rounded bg-white w-full sm:max-w-[200px] outline-none">
                                    <option value="1">x1 (Th·ª±c t·∫ø)</option>
                                    <option value="60">x60 (1p = 1s th·ª±c)</option>
                                    <option value="600">x600 (10p = 1s th·ª±c)</option>
                                    <option value="3600">x3600 (1 gi·ªù = 1s th·ª±c)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Environment & Rules Context -->
                    <div class="bg-white rounded-2xl border border-slate-200 p-4 md:p-6 shadow-sm grid grid-cols-2 md:grid-cols-4 gap-4 text-xs md:text-sm">
                        <div>
                            <span class="block text-slate-400 text-[10px] md:text-xs mb-1">Lo·∫°i ƒë·∫•t</span>
                            <span id="ai-soil-type" class="font-bold text-slate-700 capitalize">--</span>
                        </div>
                        <div>
                            <span class="block text-slate-400 text-[10px] md:text-xs mb-1">V√πng r·ªÖ</span>
                            <span id="ai-root-vol" class="font-bold text-slate-700">-- L</span>
                        </div>
                        <div>
                            <span class="block text-slate-400 text-[10px] md:text-xs mb-1">Max An to√†n</span>
                            <span id="ai-safe-max" class="font-bold text-amber-600">-- L</span>
                        </div>
                        <div>
                            <span class="block text-slate-400 text-[10px] md:text-xs mb-1">T√¨nh tr·∫°ng b∆°m</span>
                            <span id="ai-decision-text" class="font-bold text-slate-700">--</span>
                        </div>
                    </div>

                    <!-- Logs Table -->
                    <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden flex flex-col">
                        <div class="px-4 md:px-6 py-3 md:py-4 border-b border-slate-200 bg-slate-50 flex justify-between items-center">
                            <h3 class="font-bold text-slate-800 text-sm md:text-base">Nh·∫≠t k√Ω n∆∞·ªõc (B∆°m/M∆∞a)</h3>
                        </div>
                        <div class="overflow-x-auto max-h-48 md:max-h-60">
                            <table class="w-full text-left text-xs md:text-sm text-slate-600 whitespace-nowrap">
                                <thead class="bg-slate-50 sticky top-0 shadow-sm">
                                    <tr>
                                        <th class="px-4 md:px-6 py-2 font-medium">Th·ªùi gian</th>
                                        <th class="px-4 md:px-6 py-2 font-medium">L∆∞·ª£ng</th>
                                        <th class="px-4 md:px-6 py-2 font-medium">S·ª± ki·ªán</th>
                                    </tr>
                                </thead>
                                <tbody id="log-tbody" class="divide-y divide-slate-100">
                                    <!-- Logs injected here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ================= VIEW: ADMIN ================= -->
        <section id="view-admin" class="max-w-6xl mx-auto p-4 md:p-6 hidden">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-end mb-6 gap-4">
                <div>
                    <h2 class="text-xl md:text-2xl font-bold text-indigo-900">Admin Panel</h2>
                    <p class="text-slate-500 mt-1 text-xs md:text-sm">Qu·∫£n l√Ω h·ªá th·ªëng & ticket ng∆∞·ªùi d√πng.</p>
                </div>
                <div class="flex gap-2 w-full sm:w-auto">
                    <button onclick="Admin.renderAll()" class="flex-1 sm:flex-none bg-white border border-slate-300 text-slate-700 px-3 py-2 rounded-lg text-sm font-medium hover:bg-slate-50 transition">‚Üª T·∫£i l·∫°i</button>
                    <button onclick="Router.navigate('dashboard')" class="flex-1 sm:flex-none bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-slate-900 transition">Tho√°t</button>
                </div>
            </div>

            <!-- Tabs -->
            <div class="flex gap-2 md:gap-4 mb-4 border-b border-slate-200 overflow-x-auto whitespace-nowrap">
                <button onclick="Admin.switchTab('users')" id="ad-tab-users" class="px-3 md:px-4 py-2 text-sm font-bold text-indigo-600 border-b-2 border-indigo-600">Users & Plants</button>
                <button onclick="Admin.switchTab('inbox')" id="ad-tab-inbox" class="px-3 md:px-4 py-2 text-sm font-medium text-slate-500 hover:text-slate-700">H√≤m th∆∞ Tickets</button>
            </div>

            <div id="ad-view-users" class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden overflow-x-auto">
                <table class="w-full text-left text-xs md:text-sm whitespace-nowrap">
                    <thead class="bg-slate-50 text-slate-600 border-b border-slate-200">
                        <tr>
                            <th class="px-4 py-3 font-medium">Email</th>
                            <th class="px-4 py-3 font-medium">T√™n hi·ªÉn th·ªã</th>
                            <th class="px-4 py-3 font-medium">Role</th>
                            <th class="px-4 py-3 font-medium">S·ªë c√¢y</th>
                            <th class="px-4 py-3 font-medium">Tr·∫°ng th√°i</th>
                            <th class="px-4 py-3 font-medium text-right">H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody id="admin-users-tbody" class="divide-y divide-slate-100">
                        <!-- Users injected here -->
                    </tbody>
                </table>
            </div>

            <div id="ad-view-inbox" class="hidden space-y-4">
                <div id="admin-inbox-container" class="grid grid-cols-1 gap-4">
                    <!-- Inbox injected here -->
                </div>
            </div>
        </section>

    </main>

    <!-- ================= MODALS ================= -->
    <!-- Plant Form Modal -->
    <div id="modal-plant" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-xl max-h-[95vh] flex flex-col">
            <div class="px-4 md:px-6 py-3 md:py-4 border-b border-slate-100 flex justify-between items-center shrink-0">
                <h3 id="modal-plant-title" class="font-bold text-base md:text-lg text-slate-800">Th√™m c√¢y m·ªõi</h3>
                <button onclick="UI.closePlantModal()" class="text-slate-400 hover:text-slate-600 text-2xl leading-none">&times;</button>
            </div>
            <div class="p-4 md:p-6 overflow-y-auto flex-1">
                <form id="form-plant" onsubmit="handlePlantSubmit(event)" class="space-y-4">
                    <input type="hidden" id="p-id">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-slate-700 mb-1">T√™n hi·ªÉn th·ªã *</label>
                            <input type="text" id="p-name" required class="w-full p-2 border border-slate-300 rounded focus:border-emerald-500 outline-none text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-700 mb-1">Lo·∫°i th·ª±c v·∫≠t</label>
                            <select id="p-type" required class="w-full p-2 border border-slate-300 rounded focus:border-emerald-500 outline-none text-sm">
                                <option value="Tomato">C√† chua / Rau ƒÉn qu·∫£</option>
                                <option value="Lettuce">X√† l√°ch / Rau l√°</option>
                                <option value="Herb">Rau th∆°m / Th·∫£o m·ªôc</option>
                                <option value="Tree">C√¢y th√¢n g·ªó / ƒÇn qu·∫£</option>
                                <option value="Ornamental">X∆∞∆°ng r·ªìng / C√¢y c·∫£nh</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-slate-700 mb-1">H√¨nh d√°ng UI</label>
                            <select id="p-size" class="w-full p-2 border border-slate-300 rounded outline-none text-sm">
                                <option value="small">M·∫ßm non (Nh·ªè)</option>
                                <option value="medium" selected>Ph√°t tri·ªÉn (V·ª´a)</option>
                                <option value="large">Tr∆∞·ªüng th√†nh (L·ªõn)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-700 mb-1">Ng√†y gieo/tr·ªìng *</label>
                            <input type="date" id="p-date" required class="w-full p-2 border border-slate-300 rounded focus:border-emerald-500 outline-none text-sm">
                        </div>
                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-xs font-medium text-slate-700 mb-1">ƒê·ªô ·∫©m ƒë·∫•t ban ƒë·∫ßu (%)</label>
                            <input type="number" step="any" id="p-soil-init" min="0" max="100" value="40" class="w-full p-2 border border-slate-300 rounded text-sm">
                        </div>
                    </div>

                    <div class="border-t border-slate-100 pt-4 mt-2 bg-slate-50 -mx-4 md:-mx-6 px-4 md:px-6 pb-4">
                        <h4 class="text-sm font-semibold text-slate-800 mb-3">Th√¥ng s·ªë ƒê·∫•t / Ch·∫≠u (·∫¢nh h∆∞·ªüng m·ª©c b∆°m Max)</h4>
                        <div class="grid grid-cols-2 gap-4 mb-3">
                            <div>
                                <label class="block text-xs text-slate-600 mb-1">C√°ch tr·ªìng</label>
                                <select id="p-loc-type" class="w-full p-2 border border-slate-300 rounded text-sm bg-white" onchange="UI.toggleLocFields()">
                                    <option value="in_pot">Trong ch·∫≠u</option>
                                    <option value="in_soil">Tr·ª±c ti·∫øp tr√™n ƒë·∫•t</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs text-slate-600 mb-1">T√≠nh ch·∫•t ƒë·∫•t</label>
                                <select id="p-soil-type" class="w-full p-2 border border-slate-300 rounded text-sm bg-white">
                                    <option value="loam">ƒê·∫•t th·ªãt (Loam) - C√¢n b·∫±ng</option>
                                    <option value="sand">ƒê·∫•t c√°t (Sand) - Tho√°t n∆∞·ªõc nhanh</option>
                                    <option value="clay">ƒê·∫•t s√©t (Clay) - D·ªÖ √∫ng</option>
                                    <option value="silt">ƒê·∫•t ph√π sa (Silt)</option>
                                    <option value="peat">ƒê·∫•t than b√πn (Peat)</option>
                                    <option value="chalk">ƒê·∫•t ph·∫•n (Chalk)</option>
                                    <option value="loamy_sand">C√°t pha th·ªãt (Loamy Sand)</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs text-slate-600 mb-1">Di·ªán t√≠ch h·ª©ng (m¬≤)</label>
                                <input type="number" id="p-area" step="any" min="0.0001" value="0.05" class="w-full p-2 border border-slate-300 rounded text-sm">
                            </div>
                            <div id="div-pot-vol">
                                <label class="block text-xs text-slate-600 mb-1 text-red-600 font-bold">Th·ªÉ t√≠ch ch·∫≠u (L√≠t) *</label>
                                <input type="number" id="p-pot-vol" step="any" min="0.1" value="5.0" class="w-full p-2 border border-red-300 rounded text-sm bg-red-50">
                            </div>
                            <div id="div-soil-depth" class="hidden">
                                <label class="block text-xs text-slate-600 mb-1 text-indigo-600 font-bold">ƒê·ªô s√¢u r·ªÖ h·ªØu d·ª•ng (cm)</label>
                                <input type="number" id="p-soil-depth" step="any" min="1" value="30" class="w-full p-2 border border-indigo-300 rounded text-sm bg-indigo-50">
                            </div>
                        </div>
                    </div>

                    <div class="border-t border-slate-100 pt-4 mt-2">
                        <h4 class="text-sm font-semibold text-slate-800 mb-3">H·ªá th·ªëng ƒêi·ªÅu khi·ªÉn B∆°m</h4>
                        <div class="mb-3 p-3 border border-emerald-200 bg-emerald-50 rounded-lg">
                            <label class="block text-xs font-bold text-emerald-800 mb-2">Ch·∫ø ƒë·ªô v·∫≠n h√†nh ch√≠nh</label>
                            <select id="p-mode" class="w-full p-2 border border-emerald-300 rounded outline-none text-sm font-medium text-emerald-900" onchange="UI.toggleModeFields()">
                                <option value="AI">ü§ñ AI T·ª± ƒê·ªông (T·ªëi ∆∞u h√≥a Field Capacity)</option>
                                <option value="Manual">‚úã Ch·ªâ cho ph√©p b∆°m Th·ªß C√¥ng</option>
                            </select>
                            
                            <div id="div-ai-override" class="mt-3 flex items-center gap-2">
                                <input type="checkbox" id="p-ai-allow-manual" class="w-4 h-4 rounded border-emerald-400 text-emerald-600 focus:ring-emerald-500 cursor-pointer" onchange="UI.toggleModeFields()">
                                <label for="p-ai-allow-manual" class="text-xs text-emerald-700 cursor-pointer font-medium">B·∫≠t t√≠nh nƒÉng cho ph√©p x·∫£ b∆°m th·ªß c√¥ng ghi ƒë√® AI</label>
                            </div>
                        </div>

                        <div id="div-manual-vol" class="hidden mb-4 p-3 border border-blue-200 bg-blue-50 rounded-lg">
                            <label class="block text-xs text-blue-800 font-bold mb-1">M·ª©c n∆∞·ªõc b∆°m m·ªói l·∫ßn nh·∫•n th·ªß c√¥ng (L√≠t)</label>
                            <input type="number" id="p-manual-vol" step="any" value="1.0" class="w-full p-2 border border-blue-300 rounded text-sm text-blue-900 font-medium">
                        </div>

                        <div id="div-pulse-config" class="hidden bg-slate-100 p-3 rounded-lg border border-slate-200 mt-2">
                            <p class="text-[10px] text-slate-500 mb-2 uppercase font-bold tracking-wider">B·∫£o v·ªá r·ªÖ (C·∫•u h√¨nh nh·ªè gi·ªçt)</p>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-[10px] md:text-xs text-slate-700 mb-1 font-medium">M·ª©c chia nh·ªè (Pulse - L)</label>
                                    <input type="number" id="p-max-pulse" step="any" value="0.2" class="w-full p-1.5 md:p-2 border border-slate-300 rounded text-sm">
                                </div>
                                <div>
                                    <label class="block text-[10px] md:text-xs text-slate-700 mb-1 font-medium">Ngh·ªâ ng·∫•m ƒë·∫•t (Gi√¢y)</label>
                                    <input type="number" id="p-pause-int" step="any" value="120" class="w-full p-1.5 md:p-2 border border-slate-300 rounded text-sm">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" class="w-full mt-4 bg-emerald-600 text-white font-bold text-base py-3 rounded-lg hover:bg-emerald-700 transition shadow-lg">L∆ØU THI·∫æT L·∫¨P C√ÇY</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Predict Report Modal -->
    <div id="modal-predict" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md max-h-[90vh] flex flex-col overflow-hidden">
            <div class="px-4 md:px-6 py-3 md:py-4 border-b border-slate-100 flex justify-between items-center bg-indigo-50 shrink-0">
                <h3 class="font-bold text-base md:text-lg text-indigo-900">B√°o C√°o D·ª± ƒêo√°n B·ªëc H∆°i</h3>
                <button onclick="document.getElementById('modal-predict').classList.add('hidden')" class="text-indigo-400 hover:text-indigo-600 text-2xl leading-none">&times;</button>
            </div>
            <div class="p-4 md:p-6">
                <div class="text-center mb-6">
                    <p class="text-xs md:text-sm text-slate-500 mb-1">M·ª©c ·∫©m d·ª± ki·∫øn (kh√¥ng t√≠nh b∆°m) v√†o:</p>
                    <p class="font-bold text-slate-800 text-sm md:text-base" id="pre-target-time">--</p>
                </div>
                
                <div class="flex items-center justify-center mb-6 md:mb-8">
                    <div class="w-20 h-20 md:w-24 md:h-24 rounded-full border-4 border-indigo-100 flex items-center justify-center relative bg-white shadow-inner">
                        <span id="pre-pct" class="text-2xl md:text-3xl font-black text-indigo-600">--%</span>
                    </div>
                </div>

                <div class="bg-slate-50 rounded-lg p-3 md:p-4 text-xs md:text-sm space-y-2.5 border border-slate-200">
                    <div class="flex justify-between items-center"><span class="text-slate-600">ƒê·ªô ·∫©m th·ªùi ƒëi·ªÉm b·∫Øt ƒë·∫ßu:</span><span id="pre-init" class="font-bold text-slate-800">--</span></div>
                    <div class="flex justify-between items-center"><span class="text-slate-600">T·ªïng n∆∞·ªõc b·ªëc h∆°i (ETc):</span><span id="pre-evap" class="font-bold text-red-500 bg-red-50 px-2 rounded">-- L</span></div>
                    <div class="flex justify-between items-center"><span class="text-slate-600">L∆∞·ª£ng m∆∞a t·ª± nhi√™n h·ª©ng:</span><span id="pre-rain" class="font-bold text-blue-600 bg-blue-50 px-2 rounded">-- L</span></div>
                </div>
            </div>
            <div class="p-4 bg-slate-50 border-t border-slate-100">
                <button onclick="document.getElementById('modal-predict').classList.add('hidden')" class="w-full bg-slate-800 hover:bg-slate-700 transition text-white font-medium py-2 rounded-lg">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <!-- Report Bug Modal -->
    <div id="modal-report" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md max-h-[90vh] flex flex-col">
            <div class="px-4 md:px-6 py-3 md:py-4 border-b border-amber-200 bg-amber-50 flex justify-between items-center shrink-0 rounded-t-2xl">
                <h3 class="font-bold text-base md:text-lg text-amber-900">G·ª≠i Report L·ªói Tr·ª±c Ti·∫øp</h3>
                <button onclick="document.getElementById('modal-report').classList.add('hidden')" class="text-amber-500 hover:text-amber-700 text-2xl leading-none">&times;</button>
            </div>
            <div class="p-4 md:p-6">
                <form id="form-report" onsubmit="submitReport(event)" class="space-y-4">
                    <div>
                        <label class="block text-xs font-medium text-slate-700 mb-1">Ti√™u ƒë·ªÅ ng·∫Øn g·ªçn *</label>
                        <input type="text" id="r-title" required class="w-full p-2 md:p-2.5 border border-slate-300 rounded-lg outline-none text-sm focus:border-amber-500 focus:ring-1 focus:ring-amber-200" placeholder="VD: B∆°m ·∫£o, l∆∞·ª£ng n∆∞·ªõc kh√¥ng kh·ªõp">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-700 mb-1">M√¥ t·∫£ hi·ªán t∆∞·ª£ng c·ª• th·ªÉ *</label>
                        <textarea id="r-desc" required rows="4" class="w-full p-2 md:p-2.5 border border-slate-300 rounded-lg outline-none text-sm focus:border-amber-500 focus:ring-1 focus:ring-amber-200" placeholder="M√¥ t·∫£ c√°c b∆∞·ªõc d·∫´n ƒë·∫øn l·ªói..."></textarea>
                    </div>
                    <div class="bg-amber-50/50 p-3 rounded-lg text-xs text-amber-700 border border-amber-100 flex gap-2 items-start">
                        <svg class="w-4 h-4 shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span>H·ªá th·ªëng s·∫Ω ƒë√≠nh k√®m PlantID hi·ªán t·∫°i ƒë·ªÉ Dev check log d·ªÖ d√†ng.</span>
                    </div>
                    <button type="submit" class="w-full bg-amber-500 text-white font-bold py-2.5 rounded-lg hover:bg-amber-600 transition shadow-lg">G·ª≠i Report</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-4 right-4 bg-slate-800 text-white px-4 py-3 rounded-lg shadow-2xl transform translate-y-20 opacity-0 transition-all duration-300 z-[100] flex items-center gap-3">
        <span id="toast-msg" class="text-sm font-medium">Message</span>
    </div>

    <script>
        /* ==========================================
           Smart Irrigation V2
           - Fixed Health NaN jumps (Strict Parsing)
           - Dynamic Pulse calculation for extreme high speed (x3600)
           - Target Field Capacity watering for AI
           - Strict arbitrary decimal inputs (step="any") everywhere
           - Enhanced Alert Types (Heat, Low warning)
           - Auto-Revert / Time Machine functionality on 5-day limit
           ========================================== */

        const SOIL_PROPERTIES = {
            "sand": { field_capacity_pct: 10, wilting_point_pct: 4, porosity: 0.35 },
            "loam": { field_capacity_pct: 35, wilting_point_pct: 12, porosity: 0.45 },
            "clay": { field_capacity_pct: 40, wilting_point_pct: 20, porosity: 0.50 },
            "silt": { field_capacity_pct: 30, wilting_point_pct: 10, porosity: 0.48 },
            "peat": { field_capacity_pct: 50, wilting_point_pct: 15, porosity: 0.60 },
            "chalk": { field_capacity_pct: 20, wilting_point_pct: 8, porosity: 0.38 },
            "loamy_sand": { field_capacity_pct: 15, wilting_point_pct: 6, porosity: 0.36 }
        };

        const state = {
            currentUser: null,
            currentView: 'gate',
            currentPlantId: null,
            sim: {
                intervalId: null,
                multiplier: 1,      
                virtualTime: Date.now(),
                startTime: Date.now(),
                snapshot: null 
            }
        };

        const SECRETS = { GATE_CODE: '28022026' };
        
        // --- UTILS ---
        const escapeHTML = str => str.replace(/[&<>'"]/g, tag => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;'}[tag]));
        const showToast = (msg) => {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 4000);
        };
        const generateId = () => 'p_' + Math.random().toString(36).substr(2, 9);
        const formatTime = (ts) => {
            let d = new Date(ts);
            return d.toLocaleTimeString('vi-VN', {hour12: false, hour:'2-digit', minute:'2-digit'}) + ' ' + d.toLocaleDateString('vi-VN');
        };

        // --- WEATHER MANAGER ---
        const WeatherManager = {
            API_KEY: '3b0081f28b619b16e88c63e0dc813975',
            mode: 'normal',
            forecastCache: [], 
            
            async fetchForecast() {
                try {
                    const res = await fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=16.4637&lon=107.5909&appid=${this.API_KEY}&units=metric&lang=vi`);
                    if(!res.ok) throw new Error("API Limit");
                    const data = await res.json();
                    
                    this.forecastCache = data.list.map(item => ({
                        dt_ts: item.dt * 1000,
                        temp: item.main.temp,
                        humidity: item.main.humidity || 70, 
                        rain: item.rain ? (item.rain['3h'] / 3 || 0) : 0, 
                        status: item.weather[0].description
                    }));
                    
                    this.mode = 'api_sync';
                    showToast('ƒê√£ ƒë·ªìng b·ªô API D·ª± b√°o 5 ng√†y (Hu·∫ø)');
                    this.updateUI(state.sim.virtualTime);
                } catch(e) { 
                    this.generateMockForecast();
                }
            },
            generateMockForecast() {
                this.forecastCache = [];
                let baseTs = Date.now();
                for(let i=0; i<40; i++) {
                    let ts = baseTs + i * 3 * 3600 * 1000;
                    let hour = new Date(ts).getHours();
                    let isDay = (hour >= 7 && hour <= 17);
                    this.forecastCache.push({
                        dt_ts: ts,
                        temp: isDay ? (28 + Math.random()*4) : (23 + Math.random()*2),
                        humidity: isDay ? (45 + Math.random()*20) : (75 + Math.random()*15),
                        rain: Math.random() > 0.85 ? (Math.random()*4) : 0,
                        status: isDay ? "Tr·ªùi n·∫Øng (Demo)" : "ƒê√™m m√°t (Demo)"
                    });
                }
                this.mode = 'api_sync';
                showToast('API L·ªói. D√πng d·ªØ li·ªáu gi·∫£ l·∫≠p (Demo)');
                this.updateUI(state.sim.virtualTime);
            },
            setSim(type) {
                this.mode = type;
                this.updateUI(state.sim.virtualTime);
            },
            getWeatherForTimestamp(ts) {
                if (this.mode === 'sun') return { temp: 37, humidity: 30, rain: 0, status: 'N·∫Øng g·∫Øt (√âp c·ª©ng)' };
                if (this.mode === 'rain') return { temp: 24, humidity: 95, rain: 2.5, status: 'M∆∞a to (√âp c·ª©ng)' }; 
                if (this.mode === 'normal') return { temp: 28, humidity: 65, rain: 0, status: 'B√¨nh th∆∞·ªùng (√âp c·ª©ng)' };
                
                if (this.forecastCache.length === 0) return { temp: 28, humidity: 60, rain: 0, status: 'ƒêang t·∫£i...' };
                
                let closest = this.forecastCache[0];
                let minDiff = Math.abs(ts - closest.dt_ts);
                for(let i=1; i<this.forecastCache.length; i++) {
                    let diff = Math.abs(ts - this.forecastCache[i].dt_ts);
                    if(diff < minDiff) { minDiff = diff; closest = this.forecastCache[i]; }
                }
                return { temp: closest.temp, humidity: closest.humidity, rain: closest.rain, status: closest.status };
            },
            updateUI(t_sim) {
                const el = document.getElementById('lbl-weather-desc');
                if(el) el.innerText = this.getWeatherForTimestamp(t_sim).status;
            }
        };

        // --- STORAGE ---
        const DB = {
            init() {
                if (!localStorage.getItem('site_seeded_v6_admins')) {
                    const admins = [
                        { email: 'Kietvo2ktuankiet@gmail.com', password: 'Kietvo2ktuankiet@gmail.com', isAdmin: true, displayName: 'Kiet Vo', disabled: false },
                        { email: 'nhtlong11022009@gmail.com', password: 'nhtlong11022009@gmail.com', isAdmin: true, displayName: 'Long Nguyen', disabled: false },
                        { email: 'tranduydat2509@gmail.com', password: 'tranduydat2509@gmail.com', isAdmin: true, displayName: 'Dat Tran', disabled: false }
                    ];
                    localStorage.setItem('users', JSON.stringify(admins));
                    localStorage.setItem('site_seeded_v6_admins', 'true');
                }
            },
            getUsers() { return JSON.parse(localStorage.getItem('users') || '[]'); },
            saveUsers(users) { localStorage.setItem('users', JSON.stringify(users)); },
            getUser(email) { return this.getUsers().find(u => u.email === email); },
            getPlants(email) { return JSON.parse(localStorage.getItem(`plants_${email}`) || '[]'); },
            savePlants(email, plants) { localStorage.setItem(`plants_${email}`, JSON.stringify(plants)); },
            getPlant(email, plantId) { return this.getPlants(email).find(p => p.plantId === plantId); },
            
            getReports() { return JSON.parse(localStorage.getItem('reports') || '[]'); },
            addReport(report) {
                let reps = this.getReports(); reps.unshift(report); localStorage.setItem('reports', JSON.stringify(reps));
                const admins = this.getUsers().filter(u => u.isAdmin);
                admins.forEach(a => {
                    let inbox = JSON.parse(localStorage.getItem(`admin_inbox_${a.email}`) || '[]');
                    inbox.unshift(report.id); localStorage.setItem(`admin_inbox_${a.email}`, JSON.stringify(inbox));
                    let count = parseInt(localStorage.getItem(`admin_unread_${a.email}`) || '0');
                    localStorage.setItem(`admin_unread_${a.email}`, count + 1);
                });
            },
            resolveReport(reportId, reply) {
                let reps = this.getReports(); let r = reps.find(x => x.id === reportId);
                if(r) { r.status = 'resolved'; r.reply = reply; localStorage.setItem('reports', JSON.stringify(reps)); }
            }
        };

        // --- AUTH & ROUTING ---
        const Auth = {
            checkSession() {
                const loggedEmail = sessionStorage.getItem('session_currentUser');
                if (loggedEmail) {
                    const u = DB.getUser(loggedEmail);
                    if (u && !u.disabled) { state.currentUser = u; return true; }
                }
                return false;
            },
            handleLogin(e) {
                e.preventDefault();
                const email = document.getElementById('login-email').value.trim();
                const user = DB.getUser(email);
                if (!user) return showToast('T√†i kho·∫£n kh√¥ng t·ªìn t·∫°i!');
                if (user.password !== document.getElementById('login-pass').value) return showToast('Sai m·∫≠t kh·∫©u!'); 
                sessionStorage.setItem('session_currentUser', user.email);
                state.currentUser = user;
                Router.navigate('dashboard');
            },
            handleRegister(e) {
                e.preventDefault();
                const email = document.getElementById('reg-email').value.trim();
                let users = DB.getUsers();
                if (users.find(u => u.email === email)) return showToast('Email ƒë√£ t·ªìn t·∫°i!');
                const newUser = { email, password: document.getElementById('reg-pass').value, isAdmin: false, displayName: document.getElementById('reg-name').value.trim(), disabled: false };
                users.push(newUser); DB.saveUsers(users); DB.savePlants(email, []); 
                sessionStorage.setItem('session_currentUser', email);
                state.currentUser = newUser;
                Router.navigate('dashboard');
            },
            logout() { sessionStorage.removeItem('session_currentUser'); state.currentUser = null; Simulation.stop(); Router.navigate('auth'); }
        };

        const Router = {
            navigate(viewId, params = {}) {
                if (viewId !== 'howitworks' && viewId !== 'gate' && !sessionStorage.getItem('gatePassed')) return this.navigate('gate');
                if (['dashboard', 'plant', 'admin'].includes(viewId) && !Auth.checkSession()) return this.navigate('auth');
                
                document.querySelectorAll('main > section').forEach(el => el.classList.add('hidden'));
                const targetView = document.getElementById(`view-${viewId}`);
                if(targetView) targetView.classList.remove('hidden');

                const nav = document.getElementById('navbar');
                if (['dashboard', 'plant', 'admin'].includes(viewId)) {
                    nav.classList.remove('hidden');
                    document.getElementById('nav-user-name').innerText = escapeHTML(state.currentUser.displayName);
                    const btnAdmin = document.getElementById('btn-admin-panel');
                    if(state.currentUser.isAdmin) {
                        btnAdmin.classList.remove('hidden');
                        let unread = parseInt(localStorage.getItem(`admin_unread_${state.currentUser.email}`) || '0');
                        let badge = document.getElementById('admin-badge');
                        if(unread > 0) { badge.classList.remove('hidden'); badge.innerText = unread; }
                        else { badge.classList.add('hidden'); }
                    } else btnAdmin.classList.add('hidden');
                } else nav.classList.add('hidden');

                state.currentView = viewId;

                if (viewId === 'dashboard') { state.currentPlantId = null; UI.renderDashboard(); }
                if (viewId === 'plant') { state.currentPlantId = params.id; UI.renderPlantDetail(params.id); }
                if (viewId === 'admin') { Admin.renderAll(); }
                
                if (['dashboard', 'plant'].includes(viewId)) {
                    if(WeatherManager.forecastCache.length === 0) WeatherManager.fetchForecast();
                    Simulation.start();
                } else Simulation.stop();
            }
        };

        // --- UI MANAGER ---
        const UI = {
            switchAuthTab(tab) {
                document.getElementById('form-login').classList.toggle('hidden', tab !== 'login');
                document.getElementById('form-register').classList.toggle('hidden', tab !== 'register');
            },
            renderDashboard() {
                const plants = DB.getPlants(state.currentUser.email);
                const list = document.getElementById('plant-list');
                list.innerHTML = '';
                document.getElementById('empty-state').classList.toggle('hidden', plants.length > 0);
                
                plants.forEach(p => {
                    let strictHealth = parseFloat(p.health);
                    if(isNaN(strictHealth)) strictHealth = 100;

                    const hColor = (strictHealth > 70) ? 'text-blue-500' : (strictHealth > 40 ? 'text-amber-500' : 'text-red-500');
                    let icon = 'üå±';
                    if(p.plantType === 'Tree') icon = 'üå≥';
                    else if (p.plantType === 'Ornamental') icon = 'üåµ';
                    else if (p.plantType === 'Tomato') icon = 'üçÖ';

                    list.innerHTML += `
                        <div class="relative bg-white rounded-2xl border border-slate-200 p-4 md:p-5 shadow-sm hover:shadow-md transition cursor-pointer flex flex-col" onclick="Router.navigate('plant', {id: '${p.plantId}'})">
                            <div class="flex justify-between items-start mb-3">
                                <div class="w-10 h-10 md:w-12 md:h-12 bg-emerald-50 border border-emerald-100 text-emerald-600 rounded-xl flex items-center justify-center font-bold text-xl md:text-2xl shadow-inner">${icon}</div>
                                <div class="text-right">
                                    <span class="text-[10px] md:text-xs font-medium px-2 py-1 bg-slate-100 rounded block mb-1">${escapeHTML(p.plantType)}</span>
                                    <span class="text-[10px] font-bold ${hColor}">S·ª©c kh·ªèe: ${Math.round(strictHealth)}%</span>
                                </div>
                            </div>
                            <h3 class="font-bold text-base md:text-lg text-slate-800 line-clamp-1">${escapeHTML(p.displayName)}</h3>
                            <div class="w-full bg-slate-100 rounded-full h-1.5 md:h-2 mb-1 mt-auto pt-3">
                                <div class="bg-emerald-500 h-1.5 md:h-2 rounded-full transition-all" style="width: ${p.current_soil_moisture}%"></div>
                            </div>
                            <p class="text-[10px] md:text-xs text-slate-400 text-right font-medium">ƒê·∫•t: ${p.current_soil_moisture.toFixed(1)}%</p>
                        </div>
                    `;
                });
                
                if(plants.length >= 3) {
                    document.getElementById('btn-add-plant').disabled = true;
                    document.getElementById('btn-add-plant').classList.add('opacity-50', 'cursor-not-allowed');
                    document.getElementById('tooltip-plant-limit').classList.remove('hidden');
                } else {
                    document.getElementById('btn-add-plant').disabled = false;
                    document.getElementById('btn-add-plant').classList.remove('opacity-50', 'cursor-not-allowed');
                    document.getElementById('tooltip-plant-limit').classList.add('hidden');
                }
            },
            toggleLocFields() {
                const isPot = document.getElementById('p-loc-type').value === 'in_pot';
                document.getElementById('div-pot-vol').classList.toggle('hidden', !isPot);
                document.getElementById('div-soil-depth').classList.toggle('hidden', isPot);
            },
            toggleModeFields() {
                const mode = document.getElementById('p-mode').value;
                const allowManual = document.getElementById('p-ai-allow-manual').checked;
                
                document.getElementById('div-manual-vol').classList.toggle('hidden', mode === 'AI');
                document.getElementById('div-ai-override').classList.toggle('hidden', mode !== 'AI');
                
                const showPulse = mode === 'Manual' || (mode === 'AI' && allowManual);
                document.getElementById('div-pulse-config').classList.toggle('hidden', !showPulse);
            },
            openPlantModal(plantId = null) {
                const plants = DB.getPlants(state.currentUser.email);
                if (!plantId && plants.length >= 3) return showToast('B·∫°n ƒë√£ ƒë·∫°t gi·ªõi h·∫°n 3 c√¢y.');

                document.getElementById('modal-plant-title').innerText = plantId ? 'C·∫•u h√¨nh l·∫°i c√¢y' : 'Th√™m c√¢y m·ªõi';
                document.getElementById('form-plant').reset();
                document.getElementById('p-id').value = plantId || '';
                document.getElementById('p-date').value = new Date().toISOString().split('T')[0];
                
                if (plantId) {
                    const p = DB.getPlant(state.currentUser.email, plantId);
                    if(p) {
                        document.getElementById('p-name').value = p.displayName;
                        document.getElementById('p-type').value = p.plantType;
                        document.getElementById('p-size').value = p.plant_size || 'medium';
                        if(p.datePlanted) document.getElementById('p-date').value = p.datePlanted;
                        document.getElementById('p-soil-init').value = p.current_soil_moisture;
                        document.getElementById('p-loc-type').value = p.locationType || 'in_pot';
                        document.getElementById('p-soil-type').value = p.soil_type || 'loam';
                        document.getElementById('p-area').value = p.pot_area_m2;
                        
                        if(p.locationType === 'in_pot') document.getElementById('p-pot-vol').value = p.pot_volume_l || 5;
                        else document.getElementById('p-soil-depth').value = p.soil_depth_cm || 30;
                        
                        document.getElementById('p-mode').value = p.settings.mode || 'AI';
                        document.getElementById('p-ai-allow-manual').checked = !!p.settings.allowManualOverride;
                        document.getElementById('p-manual-vol').value = p.settings.manualVolume || 1.0;
                        document.getElementById('p-max-pulse').value = p.settings.maxPulseL || 0.1;
                        document.getElementById('p-pause-int').value = p.settings.pauseIntervalSec || 300;
                    }
                }
                this.toggleLocFields();
                this.toggleModeFields();
                document.getElementById('modal-plant').classList.remove('hidden');
            },
            closePlantModal() { document.getElementById('modal-plant').classList.add('hidden'); },
            
            renderPlantDetail(id) {
                const p = DB.getPlant(state.currentUser.email, id);
                if (!p) return Router.navigate('dashboard');
                
                document.getElementById('pd-name').innerText = p.displayName;
                document.getElementById('pd-type-tag').innerText = p.plantType;
                document.getElementById('pd-loc-tag').innerText = p.locationType === 'in_pot' ? 'Trong ch·∫≠u' : 'Tr√™n ƒë·∫•t';
                document.getElementById('pd-age-tag').innerText = `${p.age_days || 0} Ng√†y tu·ªïi`;
                document.getElementById('lbl-mode').innerText = p.settings.mode === 'AI' ? 'T·ª± ƒë·ªông (AI)' : 'Th·ªß c√¥ng';
                
                let limitL = p.root_zone_volume_l * 0.2;
                document.getElementById('ai-soil-type').innerText = p.soil_type || 'Loam';
                document.getElementById('ai-root-vol').innerText = `${p.root_zone_volume_l.toFixed(2)} L√≠t`;
                document.getElementById('ai-safe-max').innerText = `${limitL.toFixed(2)} L/l·∫ßn`;

                this.updatePlantVisuals(p, WeatherManager.getWeatherForTimestamp(state.sim.virtualTime));
                this.renderLogs(p.irrigation_log);
                this.renderAlerts(p);
            },
            generatePlantSVG(p) {
                let strictHealth = parseFloat(p.health);
                if(isNaN(strictHealth)) strictHealth = 100;

                let scale = p.plant_size === 'small' ? 0.7 : (p.plant_size === 'large' ? 1.3 : 1);
                let color = strictHealth < 40 ? '#f87171' : (p.current_soil_moisture < 20 || p.current_soil_moisture > 85 ? '#fbbf24' : '#4ade80');
                
                let paths = '';
                if(p.plantType === 'Tree') {
                    paths = `<path d="M45,100 L55,100 L55,40 L45,40 Z" fill="#8B4513" /><circle cx="50" cy="30" r="35" fill="${color}" opacity="0.95" />`;
                } else if (p.plantType === 'Ornamental') {
                    paths = `<ellipse cx="50" cy="60" rx="18" ry="40" fill="${color}" /><path d="M50,20 L50,100 M35,60 L65,60" stroke="#fff" stroke-width="1.5" opacity="0.4"/>`;
                } else if (p.plantType === 'Lettuce') {
                    paths = `<path d="M50,100 Q15,60 25,30 Q50,60 50,100 Z" fill="${color}" /><path d="M50,100 Q85,60 75,30 Q50,60 50,100 Z" fill="${color}" /><path d="M50,100 Q30,50 50,15 Q70,50 50,100 Z" fill="${color}" opacity="0.8"/>`;
                } else {
                    // Tomato
                    paths = `<path d="M 50 100 Q 40 60 50 20" fill="none" stroke="#22c55e" stroke-width="4" /><path d="M 48 70 Q 20 60 30 40 Q 40 50 48 70 Z" fill="${color}" /><path d="M 49 45 Q 80 30 70 10 Q 60 25 49 45 Z" fill="${color}" />`;
                    if(p.plantType === 'Tomato') paths += `<circle cx="35" cy="55" r="6" fill="#ef4444" /><circle cx="65" cy="35" r="7" fill="#ef4444" />`;
                }
                return `<g transform="translate(50, 100) scale(${scale}) translate(-50, -100)">${paths}</g>`;
            },
            updatePlantVisuals(p, weatherObj) {
                const m = p.current_soil_moisture;
                const sp = SOIL_PROPERTIES[p.soil_type || 'loam'];
                
                // Hero Status
                let statusMsg = "Tuy·ªát v·ªùi"; let statusClass = "bg-emerald-500/20 text-emerald-300 border-emerald-500/30"; let numColor = "text-emerald-400 text-glow";
                if (m < sp.wilting_point_pct + 2) { statusMsg = "Nguy k·ªãch (Kh√¥ h√©o)"; statusClass = "bg-red-500/20 text-red-300 border-red-500/30"; numColor = "text-red-400 text-glow-red"; }
                else if (m < sp.field_capacity_pct * 0.5) { statusMsg = "C·∫£nh b√°o (Thi·∫øu n∆∞·ªõc)"; statusClass = "bg-amber-500/20 text-amber-300 border-amber-500/30"; numColor = "text-amber-400 text-glow-amber"; }
                else if (m > sp.field_capacity_pct * 1.5) { statusMsg = "C·∫£nh b√°o (D∆∞ n∆∞·ªõc)"; statusClass = "bg-amber-500/20 text-amber-300 border-amber-500/30"; numColor = "text-amber-400 text-glow-amber"; }

                document.getElementById('hero-moisture-val').innerText = m.toFixed(2) + '%';
                document.getElementById('hero-moisture-val').className = `text-5xl sm:text-6xl md:text-8xl font-black tracking-tighter ${numColor}`;
                let hBadge = document.getElementById('hero-status-badge'); hBadge.className = `px-3 py-1 mt-2 sm:mt-0 rounded-full text-xs md:text-sm font-bold border ${statusClass}`; hBadge.innerText = statusMsg;
                document.getElementById('hero-updated-at').innerText = formatTime(p.last_sample_ts);

                document.getElementById('visual-temp').innerText = weatherObj.temp.toFixed(1);
                document.getElementById('visual-humidity').innerText = weatherObj.humidity.toFixed(0);
                
                const locPath = document.getElementById('svg-loc'); const locTop = document.getElementById('svg-loc-top');
                if (p.locationType === 'in_soil') { locPath.setAttribute('d', 'M 0 100 L 100 100 L 100 150 L 0 150 Z'); locPath.setAttribute('fill', '#8B4513'); locTop.setAttribute('fill', 'transparent'); }
                else { locPath.setAttribute('d', 'M 20 100 L 80 100 L 70 140 L 30 140 Z'); locPath.setAttribute('fill', '#475569'); locTop.setAttribute('fill', '#334155'); }

                document.getElementById('svg-plant-group').innerHTML = this.generatePlantSVG(p);

                let strictHealth = parseFloat(p.health);
                if(isNaN(strictHealth)) strictHealth = 100;
                
                document.getElementById('pb-health-text').innerText = strictHealth.toFixed(1) + '%';
                document.getElementById('pb-health-fill').style.width = strictHealth + '%';
                document.getElementById('pb-health-fill').className = `h-2.5 rounded-full transition-all duration-500 ${strictHealth > 70 ? 'bg-blue-500' : (strictHealth > 40 ? 'bg-amber-500' : 'bg-red-500')}`;
                document.getElementById('health-status-text').innerHTML = `L√Ω do: <b>${escapeHTML(p.stressReason || 'T·ªët')}</b>`;

                document.getElementById('sim-time').innerText = formatTime(state.sim.virtualTime);
                document.getElementById('pd-age-tag').innerText = `${p.age_days || 0} Ng√†y tu·ªïi`;

                const pStat = document.getElementById('pulsed-status');
                if (p.waterQueue && p.waterQueue.active) {
                    pStat.classList.remove('hidden'); pStat.innerText = `B∆°m nh·ªè gi·ªçt... C√≤n ${p.waterQueue.remainingL.toFixed(3)}L`;
                } else pStat.classList.add('hidden');
            },
            renderAlerts(p) {
                const panel = document.getElementById('alerts-panel');
                panel.innerHTML = '';
                const unack = (p.alerts || []).filter(a => !a.ack);
                unack.forEach(a => {
                    const color = a.level.includes('critical') ? 'bg-red-50 text-red-800 border-red-200' : 'bg-amber-50 text-amber-800 border-amber-200';
                    panel.innerHTML += `
                        <div class="flex justify-between items-center p-3 rounded-lg border ${color} shadow-sm text-xs md:text-sm">
                            <div><span class="font-bold mr-2">C·∫£nh b√°o (${formatTime(a.ts)}):</span> ${escapeHTML(a.msg)}</div>
                            <button onclick="ackAlert('${p.plantId}', ${a.ts})" class="px-2 py-1 md:px-3 md:py-1 bg-white rounded border shadow-sm hover:bg-slate-50 text-[10px] md:text-xs font-bold">ƒê√£ hi·ªÉu</button>
                        </div>`;
                });
            },
            updateAIAnalytics(decision) {
                const dText = document.getElementById('ai-decision-text');
                if (decision.isLocked) dText.innerHTML = `<span class="text-red-500 font-bold">Kh√≥a (ƒê·∫•t ∆∞·ªõt)</span>`;
                else if (decision.willIrrigate) dText.innerHTML = `<span class="text-emerald-600 font-bold">K√≠ch B∆°m: ${decision.volumeToApply.toFixed(3)}L</span>`;
                else dText.innerHTML = `<span class="text-slate-500">Standby (ƒê·ªß ·∫©m)</span>`;
            },
            renderLogs(logs) {
                const tbody = document.getElementById('log-tbody');
                tbody.innerHTML = '';
                (logs||[]).slice(0, 10).forEach(l => {
                    tbody.innerHTML += `<tr class="hover:bg-slate-50 transition-colors"><td class="px-4 md:px-6 py-2 md:py-3 border-b border-slate-100">${formatTime(l.ts)}</td><td class="px-4 md:px-6 py-2 md:py-3 font-bold text-blue-600 border-b border-slate-100">+${parseFloat(l.volume_l).toFixed(3)}L</td><td class="px-4 md:px-6 py-2 md:py-3 border-b border-slate-100"><span class="px-2 py-1 text-[9px] md:text-[10px] font-bold rounded bg-slate-100 text-slate-600 uppercase tracking-wider">${escapeHTML(l.reason)}</span></td></tr>`;
                });
            },
            openReportModal() { document.getElementById('form-report').reset(); document.getElementById('modal-report').classList.remove('hidden'); }
        };

        // --- ALGORITHMS & SIMULATION ---
        function computeIrrigationDecision(soilPct, p, weather) {
            const T = parseFloat(weather.temp);
            const H = parseFloat(weather.humidity);
            
            // Advanced ET0 with extreme heat scaling
            let ET0 = Math.max(0.5, (T * 0.15) * (1 - (H / 150))); 
            if (T > 30) ET0 *= 1.3;
            if (T > 35) ET0 *= 1.5; // Extreme evaporation

            let adjustedKc = parseFloat(p.Kc) || 0.9;
            const ETc_mm_day = ET0 * adjustedKc;
            
            const rainEff = p.locationType === 'in_pot' ? 0.4 : 0.8; // Pots catch less rain natively
            const effectiveRain = parseFloat(weather.rain) * rainEff; 
            
            const needed_mm = Math.max(0, ETc_mm_day - effectiveRain);
            // Current deficit logic
            const sp = SOIL_PROPERTIES[p.soil_type || 'loam'];
            const targetPct = sp.field_capacity_pct; // We want to pump up to Field Capacity
            
            let needed_L = 0;
            // Only calculate needed_L if we are below target
            if (soilPct < targetPct) {
                 needed_L = ((targetPct - soilPct) / 100) * parseFloat(p.root_zone_volume_l);
            }

            const isLocked = soilPct >= (sp.field_capacity_pct * 1.2); 
            const absoluteMaxL = parseFloat(p.root_zone_volume_l) * 0.2; 
            
            // AI triggers ONLY if soil drops below 60% of field capacity, to avoid constantly trickling water
            const triggerThreshold = sp.field_capacity_pct * 0.6;
            const willIrrigate = (p.settings.mode === 'AI' && soilPct < triggerThreshold && !isLocked && needed_L > 0.01);
            
            let volumeToApply = willIrrigate ? needed_L : 0;
            volumeToApply = Math.min(volumeToApply, absoluteMaxL); // Safety cap
            
            return { ET0, Kc: adjustedKc, ETc_mm_day, needed_L, willIrrigate, volumeToApply, isLocked };
        }

        const Predictor = {
            async runUserPrediction() {
                const p = DB.getPlant(state.currentUser.email, state.currentPlantId);
                const dtInput = document.getElementById('predict-datetime').value;
                if(!dtInput) return showToast('Vui l√≤ng ch·ªçn th·ªùi gian!');
                
                const targetTs = new Date(dtInput).getTime();
                const now = state.sim.virtualTime;
                
                if (targetTs <= now) return showToast('Vui l√≤ng ch·ªçn th·ªùi gian trong t∆∞∆°ng lai.');
                if (targetTs > now + 5 * 24 * 3600 * 1000) return showToast('Ch·ªâ h·ªó tr·ª£ d·ª± ƒëo√°n t·ªëi ƒëa 5 ng√†y (120 gi·ªù)!');

                let currentWaterL = parseFloat(p.root_zone_volume_l) * (parseFloat(p.current_soil_moisture) / 100);
                let t = now;
                let totalEvapL = 0; let totalRainL = 0;

                while(t < targetTs) {
                    let w = WeatherManager.getWeatherForTimestamp(t);
                    let ET0 = Math.max(0.5, (w.temp * 0.15) * (1 - (w.humidity / 150)));
                    if (w.temp > 30) ET0 *= 1.3;
                    if (w.temp > 35) ET0 *= 1.5;

                    let ETc_mm_hour = (ET0 * parseFloat(p.Kc)) / 24;
                    let evapL = ETc_mm_hour * parseFloat(p.pot_area_m2);
                    let rainL = (parseFloat(w.rain) || 0) * parseFloat(p.pot_area_m2) * (p.locationType === 'in_pot' ? 0.4 : 0.8);

                    currentWaterL = Math.max(0, currentWaterL + rainL - evapL);
                    totalEvapL += evapL; totalRainL += rainL;
                    t += 3600000;
                }

                let predictedPct = Math.min(100, (currentWaterL / parseFloat(p.root_zone_volume_l)) * 100);

                document.getElementById('pre-target-time').innerText = formatTime(targetTs);
                document.getElementById('pre-pct').innerText = predictedPct.toFixed(2) + '%';
                document.getElementById('pre-init').innerText = parseFloat(p.current_soil_moisture).toFixed(2) + '%';
                document.getElementById('pre-evap').innerText = `-${totalEvapL.toFixed(3)} L`;
                document.getElementById('pre-rain').innerText = `+${totalRainL.toFixed(3)} L`;
                
                document.getElementById('modal-predict').classList.remove('hidden');
            }
        };

        const Simulation = {
            start() {
                if (this.intervalId) clearInterval(this.intervalId);
                state.sim.virtualTime = Date.now(); 
                state.sim.startTime = state.sim.virtualTime;
                // BACKUP SNAPSHOT for Revert
                state.sim.snapshot = JSON.stringify(DB.getPlants(state.currentUser.email));

                this.intervalId = setInterval(() => this.tick(), 1000); 
            },
            stop() { if (this.intervalId) clearInterval(this.intervalId); },
            setSpeed(multiplier) { state.sim.multiplier = multiplier; showToast(`Gia t·ªëc th·ªùi gian: x${multiplier}`); },
            
            tick() {
                if (!state.currentUser) return;
                
                const tickRealMs = 1000;
                const virtualMsPassed = tickRealMs * state.sim.multiplier;
                state.sim.virtualTime += virtualMsPassed;

                // 5-DAY LIMIT -> TIME MACHINE REVERT
                if (state.sim.virtualTime - state.sim.startTime > 5 * 24 * 3600 * 1000) {
                    this.stop();
                    DB.savePlants(state.currentUser.email, JSON.parse(state.sim.snapshot)); // Revert Data
                    state.sim.multiplier = 1; document.getElementById('sim-speed').value = "1";
                    state.sim.virtualTime = Date.now();
                    alert('‚è≥ H·∫æT PHI√äN GI·∫¢ L·∫¨P: ƒê√£ ƒë·∫°t m·ªëc 5 ng√†y t∆∞∆°ng lai. H·ªá th·ªëng v·ª´a t·ª± ƒë·ªông ho√†n t√°c (Time Machine) ƒë∆∞a c√¢y v·ªÅ tr·∫°ng th√°i chu·∫©n c·ªßa th·ªùi ƒëi·ªÉm hi·ªán t·∫°i ƒë·ªÉ b·∫£o ƒë·∫£m d·ªØ li·ªáu th·ª±c t·∫ø.');
                    if (state.currentView === 'plant') UI.renderPlantDetail(state.currentPlantId);
                    else UI.renderDashboard();
                    return; 
                }

                let plants = DB.getPlants(state.currentUser.email);
                let needUIRender = false;
                const weather = WeatherManager.getWeatherForTimestamp(state.sim.virtualTime);
                const hoursPassed = virtualMsPassed / 3600000;

                plants.forEach(p => {
                    // Force rigorous numeric types to kill NaN bugs
                    p.current_soil_moisture = parseFloat(p.current_soil_moisture);
                    if(isNaN(p.current_soil_moisture)) p.current_soil_moisture = 50;
                    
                    p.root_zone_volume_l = parseFloat(p.root_zone_volume_l) || 5;
                    p.pot_area_m2 = parseFloat(p.pot_area_m2) || 0.05;
                    p.Kc = parseFloat(p.Kc) || 0.9;

                    if(p.datePlanted) {
                        p.age_days = Math.floor((state.sim.virtualTime - new Date(p.datePlanted).getTime()) / 86400000);
                        if (p.age_days < 0) p.age_days = 0;
                    }

                    // Evaporation Math
                    let waterL = p.root_zone_volume_l * (p.current_soil_moisture / 100);
                    let ET0 = Math.max(0.5, (weather.temp * 0.15) * (1 - (weather.humidity / 150)));
                    if (weather.temp > 30) ET0 *= 1.3;
                    if (weather.temp > 35) ET0 *= 1.5;

                    let evapL = (ET0 * p.Kc / 24) * p.pot_area_m2 * hoursPassed;
                    let rainEff = p.locationType === 'in_pot' ? 0.4 : 0.8;
                    let rainL = parseFloat(weather.rain) * p.pot_area_m2 * rainEff * hoursPassed;

                    waterL = Math.max(0, waterL + rainL - evapL);
                    p.current_soil_moisture = (waterL / p.root_zone_volume_l) * 100;
                    p.last_sample_ts = state.sim.virtualTime;
                    
                    const decision = computeIrrigationDecision(p.current_soil_moisture, p, weather);
                    this.checkAlerts(p, weather);

                    // --- HIGH SPEED PULSED WATERING ENGINE ---
                    if (!p.waterQueue) p.waterQueue = { active: false, remainingL: 0, nextPulseTs: 0 };
                    
                    if (p.waterQueue.active) {
                        if (state.sim.virtualTime >= p.waterQueue.nextPulseTs) {
                            const sp = SOIL_PROPERTIES[p.soil_type || 'loam'];
                            if (p.current_soil_moisture >= (sp.field_capacity_pct * 1.3)) {
                                p.waterQueue.active = false; 
                                if(state.currentView === 'plant') showToast('Safety Break: ƒê·∫•t ƒë·∫°t ng∆∞·ª°ng ng·∫≠p, h·ªßy chu·ªói b∆°m.');
                            } else {
                                let maxP = parseFloat(p.settings.maxPulseL) || 0.1;
                                let pauseMs = (parseFloat(p.settings.pauseIntervalSec) || 300) * 1000;
                                
                                // Dynamic Multiplier for high accel (e.g. x3600)
                                let timeOverdue = state.sim.virtualTime - p.waterQueue.nextPulseTs;
                                let pulseMultiplier = 1;
                                if (pauseMs > 0 && timeOverdue > pauseMs) {
                                    pulseMultiplier = 1 + Math.floor(timeOverdue / pauseMs);
                                }
                                
                                // Group missed pulses together
                                let V = Math.min(maxP * pulseMultiplier, p.waterQueue.remainingL);
                                
                                let newWaterL = (p.root_zone_volume_l * (p.current_soil_moisture / 100)) + V;
                                p.current_soil_moisture = Math.min(100, (newWaterL / p.root_zone_volume_l) * 100);
                                p.waterQueue.remainingL -= V;
                                
                                if (!p.irrigation_log) p.irrigation_log = [];
                                p.irrigation_log.unshift({ ts: state.sim.virtualTime, volume_l: V.toFixed(3), reason: 'Pulse' });
                                if (p.irrigation_log.length > 50) p.irrigation_log.pop();
                                
                                if (p.waterQueue.remainingL <= 0.001) p.waterQueue.active = false;
                                else p.waterQueue.nextPulseTs = state.sim.virtualTime + pauseMs;
                            }
                        }
                    } else if (decision.willIrrigate && p.settings.mode === 'AI') {
                        p.waterQueue = { active: true, remainingL: decision.volumeToApply, nextPulseTs: state.sim.virtualTime };
                    }

                    // --- STRICT HEALTH ENGINE ---
                    let currentHealth = parseFloat(p.health);
                    if (isNaN(currentHealth)) currentHealth = 100;

                    let healthDelta = 0; let stressReason = "ƒêi·ªÅu ki·ªán sinh tr∆∞·ªüng t·ªët";
                    const sp = SOIL_PROPERTIES[p.soil_type || 'loam'];
                    
                    if (p.current_soil_moisture > (sp.field_capacity_pct * 1.8)) { healthDelta -= 5; stressReason = "Ng·∫≠p √∫ng r·ªÖ n·∫∑ng"; }
                    else if (p.current_soil_moisture < sp.wilting_point_pct) { healthDelta -= 6; stressReason = "R·ªÖ kh√¥ h√©o"; }
                    else if (weather.temp > 35 && weather.humidity < 40) { healthDelta -= 4; stressReason = "Stress nhi·ªát (C·ª±c n√≥ng & Kh√¥)"; }
                    else if (weather.temp >= 25 && weather.temp <= 32 && weather.humidity > 85 && p.current_soil_moisture > sp.field_capacity_pct) { healthDelta -= 1; stressReason = "Nguy c∆° n·∫•m b·ªánh (D∆∞ ·∫©m)"; }
                    else { healthDelta += 1.0; } // Fast recovery when ideal
                    
                    currentHealth += (healthDelta * hoursPassed);
                    // Absolute boundary lock
                    p.health = Math.max(0, Math.min(100, currentHealth));
                    p.stressReason = stressReason;

                    if (state.currentView === 'plant' && p.plantId === state.currentPlantId) {
                        UI.updatePlantVisuals(p, weather);
                        UI.updateAIAnalytics(decision);
                        needUIRender = true;
                    }
                });

                DB.savePlants(state.currentUser.email, plants);
                if (needUIRender && state.currentView === 'plant') UI.renderLogs(DB.getPlant(state.currentUser.email, state.currentPlantId).irrigation_log);
            },

            checkAlerts(plant, weather) {
                if(!plant.alerts) plant.alerts = [];
                const m = plant.current_soil_moisture;
                const now = state.sim.virtualTime;
                
                const lastAlert = plant.alerts[0];
                if (lastAlert && (now - lastAlert.ts) < 7200000) return; // 2 hour throttle

                let msg = null; let level = null;
                const sp = SOIL_PROPERTIES[plant.soil_type || 'loam'];
                
                if (m < sp.wilting_point_pct) { msg = `NGUY HI·ªÇM: ƒê·∫•t c·∫°n ki·ªát (<${sp.wilting_point_pct}%). R·ªÖ ƒëang ch·∫øt!`; level = "critical_low"; }
                else if (m < sp.wilting_point_pct + 5) { msg = `C·∫£nh b√°o: ƒê·∫•t s·∫Øp kh√¥ h√©o, h√£y c·∫•p n∆∞·ªõc.`; level = "warning_low"; }
                else if (m > sp.field_capacity_pct * 1.8) { msg = `NG·∫¨P √öNG: ƒê·∫•t b√£o h√≤a n∆∞·ªõc (> ${sp.field_capacity_pct * 1.8}%). D·ª´ng b∆°m ngay!`; level = "critical_high"; }
                else if (m > sp.field_capacity_pct * 1.3) { msg = `C·∫£nh b√°o: ƒê·∫•t d∆∞ ∆∞·ªõt, d·ªÖ sinh n·∫•m b·ªánh.`; level = "warning_high"; }
                else if (weather.temp > 35 && weather.humidity < 40) { msg = `Stress Nhi·ªát: Th·ªùi ti·∫øt kh·∫Øc nghi·ªát, c√¢y b·ªëc h∆°i c·ª±c m·∫°nh.`; level = "warning_low"; }

                if (msg) {
                    plant.alerts.unshift({ ts: now, msg, level, ack: false });
                    if(state.currentView === 'plant' && plant.plantId === state.currentPlantId) {
                        UI.renderAlerts(plant); showToast('C·∫¢NH B√ÅO M·ªöI!');
                    }
                }
            }
        };

        // --- EVENT HANDLERS ---
        function submitReport(e) {
            e.preventDefault();
            const report = {
                id: 'rep_' + Date.now(), plantId: state.currentPlantId, userEmail: state.currentUser.email,
                title: document.getElementById('r-title').value, description: document.getElementById('r-desc').value,
                ts: Date.now(), status: 'open'
            };
            DB.addReport(report);
            document.getElementById('modal-report').classList.add('hidden');
            showToast('ƒê√£ g·ª≠i b√°o l·ªói t·ªõi Admin Inbox!');
        }

        function ackAlert(plantId, ts) {
            let plants = DB.getPlants(state.currentUser.email);
            let p = plants.find(x => x.plantId === plantId);
            if(p && p.alerts) {
                let a = p.alerts.find(x => x.ts === ts);
                if(a) a.ack = true;
                DB.savePlants(state.currentUser.email, plants);
                UI.renderAlerts(p);
            }
        }

        function checkGate() {
            if (document.getElementById('gate-code').value === SECRETS.GATE_CODE) {
                sessionStorage.setItem('gatePassed', 'true'); Router.navigate('auth');
            } else document.getElementById('gate-error').classList.remove('hidden');
        }

        function handlePlantSubmit(e) {
            e.preventDefault();
            
            const locType = document.getElementById('p-loc-type').value;
            const potVolRaw = document.getElementById('p-pot-vol').value;
            if (locType === 'in_pot' && (!potVolRaw || parseFloat(potVolRaw) <= 0)) return showToast('L·ªói: Vui l√≤ng nh·∫≠p ƒë√∫ng th·ªÉ t√≠ch ch·∫≠u');
            
            const dpStr = document.getElementById('p-date').value;
            if (new Date(dpStr) > new Date()) return showToast('L·ªói: Ng√†y tr·ªìng kh√¥ng th·ªÉ ·ªü t∆∞∆°ng lai.');

            const id = document.getElementById('p-id').value;
            let plants = DB.getPlants(state.currentUser.email);
            
            const area = parseFloat(document.getElementById('p-area').value);
            let rootVol = locType === 'in_pot' ? parseFloat(potVolRaw) : (area * (parseFloat(document.getElementById('p-soil-depth').value) / 100) * 1000);

            const plantType = document.getElementById('p-type').value;
            const kcMap = { 'Tomato': 1.15, 'Lettuce': 1.0, 'Herb': 0.90, 'Ornamental': 0.30, 'Tree': 1.0 }; 
            const mode = document.getElementById('p-mode').value;
            const allowManual = document.getElementById('p-ai-allow-manual').checked;

            const plantData = {
                plantId: id || generateId(),
                displayName: document.getElementById('p-name').value,
                plantType: plantType,
                plant_size: document.getElementById('p-size').value,
                datePlanted: dpStr,
                age_days: Math.floor((Date.now() - new Date(dpStr).getTime()) / 86400000),
                locationType: locType,
                soil_type: document.getElementById('p-soil-type').value,
                pot_area_m2: area,
                pot_volume_l: locType === 'in_pot' ? rootVol : null,
                soil_depth_cm: locType === 'in_soil' ? parseFloat(document.getElementById('p-soil-depth').value) : null,
                root_zone_volume_l: rootVol,
                Kc: kcMap[plantType] || 0.9,
                current_soil_moisture: parseFloat(document.getElementById('p-soil-init').value),
                health: 100, stressReason: 'Kh·ªüi t·∫°o', last_sample_ts: Date.now(),
                settings: {
                    mode: mode,
                    allowManualOverride: allowManual,
                    manualVolume: mode==='Manual'? parseFloat(document.getElementById('p-manual-vol').value) : null,
                    maxPulseL: parseFloat(document.getElementById('p-max-pulse').value) || 0.1,
                    pauseIntervalSec: parseFloat(document.getElementById('p-pause-int').value) || 300
                },
                notes: "", irrigation_log: [], alerts: [], waterQueue: { active: false, remainingL: 0, nextPulseTs: 0 }
            };

            if (id) {
                const idx = plants.findIndex(p => p.plantId === id);
                if(idx !== -1) {
                    plantData.irrigation_log = plants[idx].irrigation_log; plantData.health = plants[idx].health; 
                    plantData.alerts = plants[idx].alerts; plantData.waterQueue = plants[idx].waterQueue;
                    plants[idx] = plantData;
                }
            } else {
                if (plants.length >= 3) return showToast('L·ªói: ƒê√£ ƒë·∫°t gi·ªõi h·∫°n 3 c√¢y tr·ªìng!');
                plants.push(plantData);
            }

            try {
                DB.savePlants(state.currentUser.email, plants); 
                UI.closePlantModal(); 
                showToast('ƒê√£ l∆∞u c·∫•u h√¨nh c√¢y');
                UI.renderDashboard();
                if (state.currentView === 'plant') Router.navigate('plant', {id: plantData.plantId});
            } catch (err) { showToast('L·ªói l∆∞u tr·ªØ: ' + err.message); }
        }

        function manualWater() {
            let plants = DB.getPlants(state.currentUser.email);
            const p = plants.find(x => x.plantId === state.currentPlantId);
            if(p) {
                if (p.settings.mode === 'AI' && !p.settings.allowManualOverride) {
                    return showToast('C√¢y ƒëang kh√≥a AI. M·ªü C·∫•u h√¨nh -> tick "Cho ph√©p can thi·ªáp" ƒë·ªÉ x·∫£ tay.');
                }
                const limitL = parseFloat(p.root_zone_volume_l) * 0.2; 
                let V = p.settings.mode === 'Manual' ? (parseFloat(p.settings.manualVolume) || 1.0) : 1.0;
                
                if (V > limitL) {
                    showToast(`An to√†n: L∆∞·ª£ng b∆°m (${V}L) l·ªõn h∆°n 20% Root Zone. Gi·∫£m xu·ªëng ${limitL.toFixed(2)}L.`);
                    V = limitL;
                }
                
                p.waterQueue = { active: true, remainingL: V, nextPulseTs: state.sim.virtualTime };
                DB.savePlants(state.currentUser.email, plants);
                UI.updatePlantVisuals(p, WeatherManager.getWeatherForTimestamp(state.sim.virtualTime));
                showToast(`K√≠ch ho·∫°t b∆°m th·ªß c√¥ng ${V.toFixed(2)} L√≠t`);
            }
        }

        function deleteCurrentPlant() {
            if(confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a c√¢y n√†y?')) {
                let plants = DB.getPlants(state.currentUser.email);
                plants = plants.filter(p => p.plantId !== state.currentPlantId);
                DB.savePlants(state.currentUser.email, plants);
                Router.navigate('dashboard'); showToast('ƒê√£ x√≥a c√¢y');
            }
        }

        function exportPlantData() {
            const p = DB.getPlant(state.currentUser.email, state.currentPlantId);
            if(!p) return;
            const a = document.createElement('a');
            a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(p, null, 2));
            a.download = `plant_${p.plantId}.json`; a.click();
        }

        const Admin = {
            renderAll() {
                this.renderUsers(); this.renderInbox();
                let badge = document.getElementById('admin-badge');
                if(badge) badge.classList.add('hidden');
                localStorage.setItem(`admin_unread_${state.currentUser.email}`, '0');
            },
            switchTab(tab) {
                document.getElementById('ad-view-users').classList.toggle('hidden', tab !== 'users');
                document.getElementById('ad-view-inbox').classList.toggle('hidden', tab !== 'inbox');
                document.getElementById('ad-tab-users').className = tab === 'users' ? "px-3 md:px-4 py-2 text-sm font-bold text-indigo-600 border-b-2 border-indigo-600" : "px-3 md:px-4 py-2 text-sm font-medium text-slate-500 hover:text-slate-700";
                document.getElementById('ad-tab-inbox').className = tab === 'inbox' ? "px-3 md:px-4 py-2 text-sm font-bold text-indigo-600 border-b-2 border-indigo-600" : "px-3 md:px-4 py-2 text-sm font-medium text-slate-500 hover:text-slate-700";
            },
            renderUsers() {
                try {
                    const users = DB.getUsers(); const tbody = document.getElementById('admin-users-tbody');
                    tbody.innerHTML = '';
                    if (users.length === 0) { tbody.innerHTML = `<tr><td colspan="6" class="text-center py-8 text-slate-500 bg-slate-50">Kh√¥ng c√≥ d·ªØ li·ªáu h·ªá th·ªëng.</td></tr>`; return; }
                    users.forEach(u => {
                        const count = DB.getPlants(u.email).length;
                        tbody.innerHTML += `
                            <tr class="hover:bg-slate-50 border-b border-slate-100 transition-colors">
                                <td class="px-4 py-3 font-medium text-slate-700">${escapeHTML(u.email)}</td>
                                <td class="px-4 py-3">${escapeHTML(u.displayName)}</td>
                                <td class="px-4 py-3">${u.isAdmin ? '<span class="bg-indigo-100 text-indigo-700 px-2 py-1 rounded text-xs font-bold">Admin</span>' : '<span class="text-slate-500">User</span>'}</td>
                                <td class="px-4 py-3">${count} / 3</td>
                                <td class="px-4 py-3">${u.disabled ? '<span class="text-red-500 font-medium">ƒê√£ kh√≥a</span>' : '<span class="text-emerald-500 font-medium">Ho·∫°t ƒë·ªông</span>'}</td>
                                <td class="px-4 py-3 text-right">
                                    ${!u.isAdmin ? `<button onclick="Admin.toggleUser('${u.email}')" class="text-[10px] md:text-xs bg-white border border-slate-300 px-2 py-1 rounded hover:bg-slate-50 font-bold shadow-sm">${u.disabled ? 'M·ªü kh√≥a' : 'Kh√≥a'}</button>` : ''}
                                </td>
                            </tr>
                        `;
                    });
                } catch(e) {}
            },
            renderInbox() {
                try {
                    const cont = document.getElementById('admin-inbox-container'); cont.innerHTML = '';
                    const myInboxIds = JSON.parse(localStorage.getItem(`admin_inbox_${state.currentUser.email}`) || '[]');
                    const allReports = DB.getReports();
                    const myReports = allReports.filter(r => myInboxIds.includes(r.id));
                    
                    if (myReports.length === 0) {
                        cont.innerHTML = `<div class="p-8 text-center text-slate-500 bg-slate-50 rounded-xl border border-dashed border-slate-300">Kh√¥ng c√≥ Ticket l·ªói n√†o c·∫ßn x·ª≠ l√Ω.</div>`; return;
                    }
                    
                    myReports.forEach(r => {
                        const isResolved = r.status === 'resolved';
                        const badge = isResolved ? `<span class="bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded text-[10px] font-bold">ƒê√£ fix</span>` : `<span class="bg-amber-100 text-amber-700 px-2 py-0.5 rounded text-[10px] font-bold animate-pulse">Open</span>`;
                        cont.innerHTML += `
                            <div class="bg-white p-4 md:p-5 rounded-xl border ${isResolved ? 'border-slate-200' : 'border-amber-300 shadow-sm'}">
                                <div class="flex justify-between items-start mb-2">
                                    <h4 class="font-bold text-slate-800 text-sm">${escapeHTML(r.title)} ${badge}</h4>
                                    <span class="text-[10px] text-slate-400">${formatTime(r.ts)}</span>
                                </div>
                                <p class="text-xs text-slate-600 mb-3">T·ª´: <span class="font-medium text-slate-800">${escapeHTML(r.userEmail)}</span> &bull; Plant: <span class="font-mono text-[10px] bg-slate-100 px-1 rounded border border-slate-200">${r.plantId}</span></p>
                                <div class="bg-slate-50 p-3 rounded text-xs md:text-sm text-slate-700 mb-4 border border-slate-100">${escapeHTML(r.description)}</div>
                                
                                ${!isResolved ? `
                                    <div class="flex gap-2">
                                        <input type="text" id="reply-${r.id}" placeholder="Note x·ª≠ l√Ω..." class="flex-1 text-xs md:text-sm p-2 border border-slate-300 rounded outline-none focus:border-indigo-500">
                                        <button onclick="Admin.resolve('${r.id}')" class="bg-indigo-600 text-white font-medium px-3 md:px-4 py-2 rounded text-xs md:text-sm hover:bg-indigo-700 transition shadow-sm">ƒê√≥ng Ticket</button>
                                    </div>
                                ` : `
                                    <div class="text-xs md:text-sm text-indigo-700 bg-indigo-50 p-2 md:p-3 rounded border border-indigo-100"><b>Note c·ªßa Admin:</b> ${escapeHTML(r.reply || '')}</div>
                                `}
                            </div>
                        `;
                    });
                } catch(e) {}
            },
            resolve(id) {
                const reply = document.getElementById(`reply-${id}`).value;
                DB.resolveReport(id, reply); showToast('ƒê√£ ƒë√°nh d·∫•u x·ª≠ l√Ω ticket!'); this.renderInbox();
            },
            toggleUser(email) {
                let users = DB.getUsers(); const u = users.find(x => x.email === email);
                if (u && !u.isAdmin) { u.disabled = !u.disabled; DB.saveUsers(users); this.renderUsers(); }
            }
        };

        // --- INIT ---
        window.onload = () => {
            DB.init();
            if (Auth.checkSession()) Router.navigate('dashboard');
            else Router.navigate('gate');
        };

    </script>
</body>
</html>